<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ActivityManager</title>
    <link rel="stylesheet" href="../statics/css/Home.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="../statics/js/loadBoostrap.js" defer></script>
</head>
<body>
    <div id="head" class="Tophead d-flex flex-row align-items-center p-2">
        <div class="col-1 d-flex justify-content-center">
            <button id="Home" class="btn"><iconify-icon icon="ant-design:home-filled" style="color: #9747ff;" width="50" height="50"></iconify-icon></button>
        </div>
        <div class="col-5 d-flex justify-content-center">
            <h2 style="color: yellow;">管理活動</h2>
        </div>
        <div class="col-6 d-flex justify-content-center">
            <div class="col-3 p-2">
                <a href="Activities_Records.html" class="btn btn-primary" style="width: 100%; height: auto; ;background-color: #B49971;">活動紀錄</a>
            </div>
            <div class="col-3 p-2">
                <a href="Send_Announce.html" class="btn btn-primary" style="width: 100%;background-color:#065988;">發送通知</a>
            </div>
            <div class="col-3 p-2">
                <button class="btn btn-primary container" style=" width: 100%;background-color: #d35858;" data-bs-toggle="modal" data-bs-target="#EmergencyConfirmationModal">發布緊急活動</button>
            </div>
            <div class="col-3 p-2">
                <a href="General_Activity_Form.html" class="btn btn-primary container" style=" width: 100%;background-color: #009020;">發佈一般活動</a>
            </div>
        </div>
    </div>
    <div id="activityList" class="container-fluid d-grid p-2">
        <table id="activityTable" class="table table-striped">
            <thead>
                <tr>
                    <th>活動名稱</th>
                    <th>活動類型</th>
                    <th>活動舉辦人</th>
                    <th>活動地點</th>
                    <th>日期</th>
                    <th>時間</th>
                    <th>目前參與人數</th>
                    <th>活動人數上限</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>SA分享會</td>    
                    <td>系級活動</td>
                    <td>xxx</td>
                    <td>017教室</td>
                    <td>2020/12/29</td>
                    <td>13:00-18:00</td>
                    <td>120</td>
                    <td>無</td>
                    <td>
                        <div class="btn-group d-flex" role="group">
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#EditPersonalInformationModal">修改</button>
                            <button class="btn btn-primary btn-sm" style="background-color:#D91621" data-bs-toggle="modal" data-bs-target="#DeleteActivityCheckModal">撤銷</button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>    

    <!-- Emergency Confirmation -->
    <div class="modal fade modal-dialog modal-lg" id="EmergencyConfirmationModal" tabindex="-1" aria-labelledby="EmergencyConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="max-height: 700px;">
                <div class="modal-header d-flex flex-row justify-content-center " style="background-color: black;">
                    <h2 style="font-size: 30px;font-weight: 500; color: yellow;">是否消耗道具以發布緊急任務？</h2>
                </div>
                <div class="modal-footer justify-content-center">
                    <button id="EmergencyCYes" type="button" class="btn btn-primary">確認</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Unenough Emergency props -->
    <div class="modal fade modal-dialog modal-lg" id="UnenoughEmergencyPropsModal" tabindex="-1" aria-labelledby="UnenoughEmergencyPropsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="max-height: 700px;">
                <div class="modal-header d-flex flex-row justify-content-center " style="background-color: black;">
                    <h2 style="font-size: 30px;font-weight: 500; color: yellow;">道具不足！無法發布"緊急任務"</h2>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">確認</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Activity Check -->
    <div class="modal fade modal-dialog modal-lg" id="DeleteActivityCheckModal" tabindex="-1" aria-labelledby="DeleteActivityCheckModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="max-height: 700px;">
                <div class="modal-header d-flex flex-row justify-content-center " style="background-color: black;">
                    <h2 style="font-size: 30px;font-weight: 500; color: yellow;">是否確認撤銷此活動？</h2>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-primary">確認</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit  Activities Modify -->
    <div class="modal fade modal-dialog modal-lg" id="EditPersonalInformationModal" tabindex="-1" aria-labelledby="EditPersonalInformationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" style="max-height: 700px;">
                <div class="modal-header d-flex flex-row justify-content-center " style="background-color: black;">
                    <h2 style="font-size: 30px;font-weight: 500; color: yellow;">修改資訊</h2>
                </div>
                <div class="modal-body d-flex flex-column" style="overflow-y: scroll; word-wrap: break-word;max-height:fit-content;">
                    <form id="EditForm">
                        <form id="GeneralActivityForm" action="">
                            <div class="input-group mb-3 ">
                                <label class="input-group-text" for="ActivityNameInput">活動名稱：</label>
                                <input id="ActivityNameInput" type="text" class="form-control-p" placeholder="ex:請填入活動的名稱" aria-label="ActivityName" required>
                            </div>
                            <div class="input-group mb-3">
                                <label class="input-group-text" for="FirstNameInput">活動發布型別：</label>
                                <select id="PublishTypeInput" class="form-select">
                                    <option>緊急活動</option>
                                </select>
                            </div>
                            
                            <div class="input-group mb-3">
                                <label class="input-group-text" for="MaxMemberInput">活動類型：</label>
                                <select id="disabledSelect" class="form-select">
                                    <option>校級活動</option>
                                    <option>系級活動</option>
                                    <option>社團活動</option>
                                    <option>靜態休閒活動</option>
                                    <option>動態休閒活動</option>
                                    <option>其他</option>
                                </select>
                            </div>
                
                            <div class="input-group mb-3">
                                <label class="input-group-text" for="FirstNameInput">活動發起人：</label>
                                <input id="PublisherInput" type="text" class="form-control" placeholder="請填入您現在登入的使用者名稱" aria-label="Publisher" required>
                            </div>
                            <div class="input-group mb-3">
                                <label class="input-group-text" for="FirstNameInput">活動地點：</label>
                                <input id="LocationInput" type="text" class="form-control" placeholder="請填入活動的舉辦地點" aria-label="Location" required>
                            </div>
                            <div class="input-group mb-3">
                                <label class="input-group-text" for="FirstNameInput">活動人數下限：</label>
                                <input id="MinMemberInput" type="text" class="form-control" placeholder="該活動最低需求人數是多少" aria-label="MinMember" required>
                            </div>
                            <div class="input-group mb-3">
                                <label class="input-group-text" for="MaxMemberInput">活動人數上限：</label>
                                <input id="MaxMemberInput" type="text" class="form-control" placeholder="該活動最高可容納幾人參加" aria-label="MaxMember" required>
                            </div>
                
                            <div class="input-group date mb-3" data-provide="datepicker" data-target-input="nearest">
                                <label class="input-group-text" for="StartDatePicker">活動開始日期：</label>
                                <input id="StartDatePicker" type="text" class="form-control" placeholder="月/日/年" required>
                                <div class="input-group-addon">
                                    <span class="glyphicon glyphicon-th"></span>
                                </div>
                            </div>
                
                            <div class="input-group mb-3">
                                <label class="input-group-text" for="StartTimeInput">活動開始時間</label>
                                <input id="StartTimeInput" type="text" class="form-control" placeholder="(24小時制) ex: 21:00" aria-label="StarTime" required>
                            </div>
                
                            <div class="input-group date mb-3" data-provide="datepicker">
                                <label class="input-group-text" for="EndDatePicker">活動結束日期：</label>
                                <input id="EndDatePicker" type="text" class="form-control" placeholder="月/日/年" required>
                                <div class="input-group-addon">
                                    <span class="glyphicon glyphicon-th"></span>
                                </div>
                            </div>
                
                            <div class="input-group mb-3">
                                <label class="input-group-text" for="EndTimeInput">活動結束時間</label>
                                <input id="EndTimeInput" type="text" class="form-control" placeholder="(24小時制) ex: 21:00" aria-label="EndTime" required>
                            </div>
                
                            <div class="input-group mb-3">
                                <label class="input-group-text" for="ContentInput">活動內容：</label>
                                <textarea name="Conment" id="ContentInput" cols="100" rows="20" placeholder="請簡單描述您的活動" required></textarea>
                            </div>
                            <div class="col-md-12 p-0" >
                                <button id="Submit" type="submit" class="btn btn-primary btn-lg mb-3" style="width:100% ;font-size:x-large; background-color:rgba(193, 17, 209, 0.856);">確認發布</button>
                            </div>
                        </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
$(document).ready(function(){
	// 使用函數獲取 user_id 和 user_name 的值
	var user_id = getCookieValue('user_id');
	var user_name = getCookieValue('user_name');
	// 使用 user_id 做其他處理
	$("#showUserID").text(user_id);
	$("#showUserName").text(user_name);
	console.log(user_id);
	console.log(user_name);
    getAllActivity();
    function getCookieValue(cookieName) {
	    const cookies = document.cookie.split(';');
	    const cookie = cookies.find(cookie => cookie.trim().startsWith(`${cookieName}=`));
	
	    if (cookie) {
	        const [, value] = cookie.split('=');
	        return decodeURIComponent(value);
	    }
	
	    return null;
	}
	
	function getByID(user_id){
		$.ajax({
			type:"GET",
			url: "api/ActivityController.do",
			crossDomain: true,
			cache: false,
			dataType: 'json',
			timeout: 5000,
			success: function (response){
				console.log(response);
            	if(response.status == 200){
                	updateActivityTable(response.response.data);
                    // 監聽活動詳細內容按鈕的點擊事件
			}
		}
	});
    function getAllActivity() {
        // 發出POST的GET請求取得所有會員列表
        $.ajax({
                type: "GET",
                url: "api/ActivityController.do",
                crossDomain: true,
                cache: false,
                dataType: 'json',
                timeout: 5000,
                success: function (response) {
                    if(response.status == 200){
                        updateActivityTable(response.response.data);
                            // 監聽活動詳細內容按鈕的點擊事件
                            $(".activity-detail-btn").on("click", function() {
                                // 獲取按鈕上的活動ID
                                var activityId = $(this).attr("id");
                                // 直接在這裡處理模態框內容更新，不需要再發送請求
                                var activityDetail = getActivityDetailById(response.response.data, activityId);
                                updateActivityModalContent(activityDetail);
                                // 顯示模態框
                                $("#ActivityDetail").modal("show");
                        });
                    }
                    console.log(response.response.data);
                },
                error: function () {
                    alert("無法連線到伺服器！");
                }
        });
    }
    // 根據活動ID從資料中獲取詳細內容
    function getActivityDetailById(data, activityId) {
        var result = null;
        var breakLoop = false;
        $.each(data, function(index, value) {
			console.log("value['id']: " + value['id']);
        	console.log("activityId: " + activityId);
            if (value['id'] === parseInt(activityId) && breakLoop === false) {
                console.log("Match found:");
                result = value;
                console.log(value["id"]);
                console.log(activityId);
                console.log(result);
                breakLoop = true;
            }
        });
        return result;
    }
    
    function updateActivityTable(data) {
        $("#activityTable > tbody").empty();
        var table_html = '';
        $.each(data, function(index, value) {
            table_html += '<tr>';
            table_html += '<td>' + value['activity_name'] + '</td>';
            table_html += '<td>' + value['activity_type'] + '</td>';
            table_html += '<td>' + value['activity_publisher_id'] + '</td>';
            table_html += '<td>' + value['activity_place'] + '</td>';
            table_html += '<td>' + value['start_date'] + '</td>';
            table_html += '<td>' + value['start_time'] + '-' + value['end_time'] + '</td>';             
            table_html += '<td>' + value['activity_participant'] + '</td>';
            table_html += '<td>' + value['maximum_participant'] + '</td>';    
            table_html += '<td><div class="btn-group d-flex" role="group">';
            table_html += '<button type="button" class="activity-detail-btn btn btn-primary btn-sm" id = "'+ value['id'] + '">' +'詳細內容</button>';
            table_html += '<button id = "' + value['id'] + '" class="Join_Button' + 'Join_Button' + value['id'] + '" btn btn-primary btn-sm" style="background-color: rgb(0, 180, 0);">參加</button>';
            table_html += '</div></td>';
            table_html += '<tr>';
        })
        $("#activityTable > tbody").append(table_html);
    }
    // 更新活動詳細資訊模態框內容
    function updateActivityModalContent(activityDetail) {
        // 在這裡更新模態框內容，例如：
        $("#activity_title").text(activityDetail.activity_name);
        $("#activity_publish_type").text(activityDetail.activity_status);
        $("#activity_type").text(activityDetail.activity_type);
        $("#activity_publisher_id").text(activityDetail.activity_publisher_id);
        $("#start_date").text(activityDetail.start_date);
        $("#Time").text(activityDetail.start_time+"-"+activityDetail.end_time);
        $("#activity_location").text(activityDetail.activity_place);
        $("#participant_number").text(activityDetail.activity_participant);
        $("#minimum_participant").text(activityDetail.minimum_participant);
        $("#maximum_participant").text(activityDetail.maximum_participant);
        $("#activity_detail").text(activityDetail.activity_detail);

        // ...（更新其他詳細內容）
    }
});
    // 獲取所有擁有 class="Join_Button" 的按鈕
    var Join_Buttons = document.querySelectorAll(".Join_Button");
    Join_Buttons.forEach(function(Join_Button) {
        Join_Button.addEventListener("click", function() {

            // 獲取該Join_Button 的類別
            var joinActivityNumber = "Join_Button"+Join_Button.id;
            var joinActivityNumbers = document.querySelectorAll("."+joinActivityNumber);
            // 獲取元素的背景顏色   
            var computedStyle = window.getComputedStyle(Join_Button);
            var backgroundColor = computedStyle.backgroundColor;

			console.log(joinActivityNumber);
			console.log(joinActivityNumbers);
            // 判斷元素的背景顏色，進行相應的操作
            if (backgroundColor === "rgb(0, 180, 0)" || backgroundColor === "#00B400") {
                joinActivityNumbers.forEach(function(button) {
                    button.style.backgroundColor = "#D91621";
                    button.innerHTML = "取消參加";
                });
            } else {
                joinActivityNumbers.forEach(function(button) {
                    button.style.backgroundColor = "#00B400";
                    button.innerHTML = "參加";
                });
            }
        });
    });
    
    document.getElementById("Home").addEventListener("click", function() {
        // if(authication=="一般使用者"){

        // }
        // else{}
        window.location.href = "../HomeList_NormalUser.html";
    });

    
    document.getElementById("EmergencyCYes").addEventListener("click", function() {    // if(道具不足){
        // if(){

        // } else{

        // }
            // }
        window.location.href = "Emergency_Activity_Form.html";
    });
    
</script>
</html>